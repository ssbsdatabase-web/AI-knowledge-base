<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge Base - „Éû„Éã„É•„Ç¢„É´„Éª‰ªïÊßòÊõ∏Ê§úÁ¥¢</title>
    <style>
        /* ============================================
           AI Knowledge Base - iOSÈ¢®„Çπ„Çø„Ç§„É´
           ============================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* „Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà */
            --primary-color: #007AFF;
            --secondary-color: #5AC8FA;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --background-color: #F5F5F5;
            --card-background: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #E5E5EA;
            --user-message-bg: #007AFF;
            --user-message-text: #FFFFFF;
            --ai-message-bg: #E5E5EA;
            --ai-message-text: #000000;
            
            /* „Çø„Ç§„Éù„Ç∞„É©„Éï„Ç£ */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            
            /* „Çπ„Éö„Éº„Ç∑„É≥„Ç∞ */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-2xl: 24px;
            
            /* „Éú„Éº„ÉÄ„Éº„É©„Éá„Ç£„Ç¶„Çπ */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* „Ç∑„É£„Éâ„Ç¶ */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* ============================================
           „É¨„Ç§„Ç¢„Ç¶„Éà
           ============================================ */

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background-color: var(--background-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }

        .header-content h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .header-content p {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            -webkit-overflow-scrolling: touch;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-full);
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* „Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏ */
        .welcome-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-2xl);
            margin: auto;
        }

        .welcome-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-lg);
        }

        .welcome-message h2 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .welcome-message p {
            color: var(--text-secondary);
            font-size: var(--font-size-base);
            line-height: 1.6;
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏„Éê„Éñ„É´ */
        .message {
            display: flex;
            margin-bottom: var(--spacing-md);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 85%;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-xl);
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
        }

        .message.user .message-bubble {
            background-color: var(--user-message-bg);
            color: var(--user-message-text);
            border-bottom-right-radius: var(--radius-md);
        }

        .message.assistant .message-bubble {
            background-color: var(--ai-message-bg);
            color: var(--ai-message-text);
            border-bottom-left-radius: var(--radius-md);
        }

        .message-time {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
            margin-top: var(--spacing-xs);
            text-align: right;
        }

        .message.assistant .message-time {
            text-align: left;
        }

        /* „ÇΩ„Éº„ÇπÊÉÖÂ†± */
        .message-sources {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .source-item {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .source-item:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .source-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .source-detail {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--ai-message-bg);
            border-radius: var(--radius-xl);
            width: fit-content;
            margin-left: 0;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ============================================
           ÂÖ•Âäõ„Ç®„É™„Ç¢
           ============================================ */

        .input-area {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            min-height: 60px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .message-input {
            flex: 1;
            min-width: 150px;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .message-input::placeholder {
            color: var(--text-tertiary);
        }

        /* „Éú„Çø„É≥ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
        .btn-base {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-full);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            white-space: nowrap;
            min-height: 44px;
            -webkit-touch-callout: none;
        }

        .btn-base:active {
            transform: scale(0.95);
        }

        .btn-base:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ë®òÊÜ∂„Éú„Çø„É≥ */
        .btn-memory {
            background-color: var(--success-color);
            color: white;
            min-width: 60px;
        }

        .btn-memory:hover:not(:disabled) {
            background-color: #2EBF4F;
            box-shadow: var(--shadow-md);
        }

        /* „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥ */
        .btn-upload {
            background-color: var(--warning-color);
            color: white;
            min-width: 80px;
        }

        .btn-upload:hover:not(:disabled) {
            background-color: #E68900;
            box-shadow: var(--shadow-md);
        }

        /* ÈÄÅ‰ø°„Éú„Çø„É≥ */
        .btn-send {
            background-color: var(--primary-color);
            color: white;
            width: 44px;
            height: 44px;
            padding: 0;
            min-width: unset;
        }

        .btn-send:hover:not(:disabled) {
            background-color: #0051D5;
            box-shadow: var(--shadow-md);
        }

        .btn-icon {
            font-size: var(--font-size-lg);
        }

        .btn-label {
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        /* ============================================
           „É¢„Éº„ÉÄ„É´
           ============================================ */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-content {
            background-color: var(--card-background);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-2xl);
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        /* „Éï„Ç©„Éº„É†„Ç∞„É´„Éº„Éó */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* „É¢„Éº„ÉÄ„É´„Éú„Çø„É≥ */
        .btn-cancel {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--border-color);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-cancel:hover {
            background-color: #D1D1D6;
        }

        .btn-save {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-save:hover {
            background-color: #0051D5;
        }

        /* ============================================
           „É¨„Çπ„Éù„É≥„Ç∑„Éñ
           ============================================ */

        @supports (padding: max(0px)) {
            body {
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }

            .input-area {
                padding-bottom: max(var(--spacing-md), env(safe-area-inset-bottom));
            }
        }

        @media (max-width: 768px) {
            .message-bubble {
                max-width: 90%;
            }

            .btn-label {
                display: none;
            }

            .btn-memory,
            .btn-upload {
                min-width: 44px;
                padding: var(--spacing-md);
            }

            .input-area {
                gap: var(--spacing-xs);
                padding: var(--spacing-sm);
            }

            .message-input {
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .modal-content {
                border-radius: var(--radius-lg);
                max-height: 80vh;
                margin: var(--spacing-lg);
            }

            .modal {
                align-items: center;
            }
        }

        @media (max-width: 768px) {
            .header-content h1 {
                font-size: var(--font-size-xl);
            }

            .header-content p {
                font-size: var(--font-size-sm);
            }

            .messages-container {
                padding: var(--spacing-md);
            }

            .message-bubble {
                max-width: 95%;
                padding: var(--spacing-md);
            }

            .btn-send {
                width: 44px;
                height: 44px;
                min-width: 44px;
                min-height: 44px;
            }

            .btn-memory,
            .btn-upload {
                min-width: 44px;
                height: 44px;
                padding: var(--spacing-md);
            }

            .btn-label {
                display: none;
            }

            .message-input {
                min-height: 44px;
                font-size: 16px;
            }

            .input-area {
                min-height: 56px;
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: var(--spacing-md);
            }
        }

        @media (max-height: 600px) {
            .chat-header {
                padding: var(--spacing-md);
            }

            .header-content h1 {
                font-size: var(--font-size-lg);
                margin-bottom: 0;
            }

            .header-content p {
                font-size: var(--font-size-sm);
                display: none;
            }

            .btn-label {
                display: none;
            }
        }

        /* ============================================
           „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
           ============================================ */

        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="chat-header">
            <div class="header-content">
                <h1>AI Knowledge Base</h1>
                <p>„Éû„Éã„É•„Ç¢„É´„Éª‰ªïÊßòÊõ∏„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
        </div>

        <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä -->
        <div class="messages-container" id="messagesContainer">
            <div class="welcome-message">
                <div class="welcome-icon">üìö</div>
                <h2>„Çà„ÅÜ„Åì„Åù</h2>
                <p>„Éû„Éã„É•„Ç¢„É´„ÇÑ‰ªïÊßòÊõ∏„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                    Âè≥Èö£„ÅÆ„Éú„Çø„É≥„ÅßPDF„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÄÅÂ∑¶„ÅÆ„Éú„Çø„É≥„ÅßÁü•Ë≠ò„ÇíÁôªÈå≤„Åß„Åç„Åæ„Åô
                </p>
            </div>
        </div>

        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
        <div class="loading-indicator" id="loadingIndicator" style="display: none;">
            <div class="spinner"></div>
            <span>Âá¶ÁêÜ‰∏≠...</span>
        </div>

        <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
        <div class="input-area">
            <button class="btn-base btn-memory" id="memoryBtn" title="Áü•Ë≠ò„ÇíÁôªÈå≤">
                <span class="btn-icon">üíæ</span>
                <span class="btn-label">Ë®òÊÜ∂</span>
            </button>

            <button class="btn-base btn-upload" id="uploadBtn" title="PDF„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ">
                <span class="btn-icon">üì§</span>
                <span class="btn-label">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
            </button>

            <input 
                type="text" 
                id="messageInput" 
                class="message-input" 
                placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                autocomplete="off"
            >

            <button class="btn-base btn-send" id="sendBtn" title="ÈÄÅ‰ø°">
                <span class="btn-icon">‚û§</span>
            </button>

            <!-- Èö†„Åó„Éï„Ç°„Ç§„É´„Ç§„É≥„Éó„ÉÉ„Éà -->
            <input 
                type="file" 
                id="fileInput" 
                style="display: none;" 
                accept=".pdf,.html,.txt"
            >
        </div>
    </div>

    <!-- Áü•Ë≠òÁôªÈå≤„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="memoryModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Áü•Ë≠ò„ÇíÁôªÈå≤</h2>
                <button class="modal-close" id="closeMemoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="knowledgeTitle">„Çø„Ç§„Éà„É´</label>
                    <input 
                        type="text" 
                        id="knowledgeTitle" 
                        placeholder="‰æãÔºö„ÉØ„Ç§„É§„É¨„Çπ„Éû„Ç§„ÇØË®≠ÂÆöÊñπÊ≥ï"
                        maxlength="100"
                    >
                </div>
                <div class="form-group">
                    <label for="knowledgeContent">ÂÜÖÂÆπ</label>
                    <textarea 
                        id="knowledgeContent" 
                        placeholder="Áü•Ë≠ò„ÅÆË©≥Á¥∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                        rows="6"
                    ></textarea>
                </div>
                <div class="form-group">
                    <label for="knowledgeTags">„Çø„Ç∞Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ</label>
                    <input 
                        type="text" 
                        id="knowledgeTags" 
                        placeholder="‰æãÔºösetup,wireless,audio"
                    >
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancelMemoryBtn">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn-save" id="saveMemoryBtn">ÁôªÈå≤</button>
            </div>
        </div>
    </div>

    <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="modal-overlay" id="modalOverlay" style="display: none;"></div>

    <script>
        /**
         * AI Knowledge Base - „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
         * „Çπ„Çø„É≥„Éâ„Ç¢„É≠„É≥ÁâàÔºà„Çµ„Éº„Éê„Éº‰∏çË¶ÅÔºâ
         */

        class AIKnowledgeBase {
            constructor() {
                this.messages = [];
                this.knowledge = [];
                this.documents = [];
                this.init();
            }

            init() {
                this.loadData();
                this.setupEventListeners();
            }

            /**
             * „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
             */
            setupEventListeners() {
                // ÈÄÅ‰ø°„Éú„Çø„É≥
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());

                // Ë®òÊÜ∂„Éú„Çø„É≥
                document.getElementById('memoryBtn').addEventListener('click', () => this.openMemoryModal());

                // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥
                document.getElementById('uploadBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));

                // „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÔºàEnter„Ç≠„ÉºÔºâ
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // „É¢„Éº„ÉÄ„É´„ÇØ„É≠„Éº„Ç∫
                document.getElementById('closeMemoryModal').addEventListener('click', () => this.closeMemoryModal());
                document.getElementById('cancelMemoryBtn').addEventListener('click', () => this.closeMemoryModal());
                document.getElementById('saveMemoryBtn').addEventListener('click', () => this.saveMemory());
                document.getElementById('modalOverlay').addEventListener('click', () => this.closeMemoryModal());
            }

            /**
             * „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
             */
            loadData() {
                // LocalStorage„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
                const savedMessages = localStorage.getItem('messages');
                const savedKnowledge = localStorage.getItem('knowledge');
                const savedDocuments = localStorage.getItem('documents');

                this.messages = savedMessages ? JSON.parse(savedMessages) : [];
                this.knowledge = savedKnowledge ? JSON.parse(savedKnowledge) : [];
                this.documents = savedDocuments ? JSON.parse(savedDocuments) : [];

                // documents „Éï„Ç©„É´„ÉÄ„Åã„ÇâËá™ÂãïË™≠„ÅøËæº„Åø
                this.loadDocumentsFromFolder();

                this.renderMessages();
            }

            loadDocumentsFromFolder() {
                fetch('documents/')
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const links = doc.querySelectorAll('a[href]');
                        let hasNewDocs = false;
                        
                        links.forEach(link => {
                            const href = link.getAttribute('href');
                            if (href && !href.startsWith('?') && !href.startsWith('/') && href !== '../') {
                                const fileName = href.split('/').pop();
                                const fileExt = fileName.split('.').pop().toLowerCase();
                                
                                if (['pdf', 'html', 'txt'].includes(fileExt)) {
                                    const existingDoc = this.documents.find(d => d.name === fileName);
                                    if (!existingDoc) {
                                        this.documents.push({
                                            id: 'repo-' + Date.now(),
                                            name: fileName,
                                            size: 0,
                                            type: this.getMimeType(fileExt),
                                            uploadedAt: new Date().toLocaleString('ja-JP'),
                                            source: 'repository',
                                            path: 'documents/' + fileName
                                        });
                                        hasNewDocs = true;
                                    }
                                }
                            }
                        });
                        if (hasNewDocs) this.saveData();
                    })
                    .catch(err => console.log('documents „Éï„Ç©„É´„ÉÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'));
            }

            getMimeType(ext) {
                const types = {'pdf': 'application/pdf', 'html': 'text/html', 'txt': 'text/plain'};
                return types[ext] || 'application/octet-stream';
            }

            /**
             * „Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
             */
            saveData() {
                localStorage.setItem('messages', JSON.stringify(this.messages));
                localStorage.setItem('knowledge', JSON.stringify(this.knowledge));
                localStorage.setItem('documents', JSON.stringify(this.documents));
            }

            /**
             * „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
             */
            sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();

                if (!message) return;

                // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
                this.addMessage('user', message);
                input.value = '';

                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                this.showLoading();

                // AIÂøúÁ≠î„ÇíÁîüÊàêÔºàÈùûÂêåÊúüÔºâ
                setTimeout(() => {
                    this.generateAIResponse(message);
                }, 500);
            }

            /**
             * „É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
             */
            addMessage(type, content, sources = null) {
                const message = {
                    id: Date.now(),
                    type: type,
                    content: content,
                    sources: sources,
                    timestamp: new Date().toLocaleString('ja-JP')
                };

                this.messages.push(message);
                this.saveData();
                this.renderMessages();
                this.scrollToBottom();
            }

            /**
             * AIÂøúÁ≠î„ÇíÁîüÊàê
             */
            generateAIResponse(query) {
                this.hideLoading();

                // Áü•Ë≠ò„Éô„Éº„Çπ„Åã„ÇâÈñ¢ÈÄ£ÊÉÖÂ†±„ÇíÊ§úÁ¥¢
                const results = this.searchKnowledge(query);

                if (results.length === 0) {
                    this.addMessage('assistant', 
                        'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÈñ¢ÈÄ£„Åô„ÇãÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\n' +
                        '‰ª•‰∏ã„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑÔºö\n' +
                        '‚Ä¢ Âà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ\n' +
                        '‚Ä¢ Âè≥„ÅÆ„Éú„Çø„É≥„ÅßPDF„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n' +
                        '‚Ä¢ Â∑¶„ÅÆ„Éú„Çø„É≥„ÅßÁü•Ë≠ò„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
                    );
                    return;
                }

                // Ê§úÁ¥¢ÁµêÊûú„Çí„Åæ„Å®„ÇÅ„Å¶ÂøúÁ≠î„ÇíÁîüÊàê
                const summary = this.generateSummary(query, results);
                this.addMessage('assistant', summary, results);
            }

            /**
             * Áü•Ë≠ò„Éô„Éº„Çπ„ÇíÊ§úÁ¥¢
             */
            searchKnowledge(query) {
                const results = [];
                const queryWords = query.toLowerCase().split(/\s+/);

                // „É¶„Éº„Ç∂„ÉºÁü•Ë≠ò„ÇíÊ§úÁ¥¢
                for (const item of this.knowledge) {
                    let score = 0;

                    // „Çø„Ç§„Éà„É´„Åß„ÅÆ„Éû„ÉÉ„ÉÅ
                    for (const word of queryWords) {
                        if (item.title.toLowerCase().includes(word)) {
                            score += 3;
                        }
                        if (item.content.toLowerCase().includes(word)) {
                            score += 1;
                        }
                        if (item.tags && item.tags.some(tag => tag.toLowerCase().includes(word))) {
                            score += 2;
                        }
                    }

                    if (score > 0) {
                        results.push({
                            type: 'knowledge',
                            title: item.title,
                            content: item.content,
                            tags: item.tags,
                            score: score,
                            timestamp: item.timestamp
                        });
                    }
                }

                // „Éâ„Ç≠„É•„É°„É≥„Éà„ÇíÊ§úÁ¥¢
                for (const doc of this.documents) {
                    let score = 0;

                    for (const word of queryWords) {
                        if (doc.name.toLowerCase().includes(word)) {
                            score += 2;
                        }
                    }

                    if (score > 0) {
                        results.push({
                            type: 'document',
                            title: doc.name,
                            content: `„Éï„Ç°„Ç§„É´: ${doc.name}`,
                            score: score,
                            timestamp: doc.uploadedAt
                        });
                    }
                }

                // „Çπ„Ç≥„Ç¢„Åß„ÇΩ„Éº„Éà
                results.sort((a, b) => b.score - a.score);

                return results.slice(0, 5); // „Éà„ÉÉ„Éó5„ÇíËøî„Åô
            }

            /**
             * Ë¶ÅÁ¥Ñ„ÇíÁîüÊàê
             */
            generateSummary(query, results) {
                const topResult = results[0];

                let summary = '';

                if (topResult.type === 'knowledge') {
                    summary = `„Äå${topResult.title}„Äç„Åã„ÇâÔºö\n\n${topResult.content}`;
                } else if (topResult.type === 'document') {
                    summary = `„Éâ„Ç≠„É•„É°„É≥„Éà„Äå${topResult.title}„Äç„Å´Èñ¢ÈÄ£„Åô„ÇãÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ`;
                }

                if (results.length > 1) {
                    summary += `\n\n‰ªñ„Å´${results.length - 1}‰ª∂„ÅÆÈñ¢ÈÄ£ÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`;
                }

                return summary;
            }

            /**
             * „É°„ÉÉ„Çª„Éº„Ç∏„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
             */
            renderMessages() {
                const container = document.getElementById('messagesContainer');

                // „Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
                const welcome = container.querySelector('.welcome-message');
                if (welcome && this.messages.length > 0) {
                    welcome.remove();
                }

                // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
                for (const msg of this.messages) {
                    const existingMsg = container.querySelector(`[data-message-id="${msg.id}"]`);
                    if (!existingMsg) {
                        const msgEl = this.createMessageElement(msg);
                        container.appendChild(msgEl);
                    }
                }
            }

            /**
             * „É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†„Çí‰ΩúÊàê
             */
            createMessageElement(msg) {
                const div = document.createElement('div');
                div.className = `message ${msg.type}`;
                div.setAttribute('data-message-id', msg.id);

                let html = `
                    <div class="message-bubble">
                        ${this.escapeHtml(msg.content)}
                `;

                if (msg.sources && msg.sources.length > 0) {
                    html += `
                        <div class="message-sources">
                            <strong style="font-size: 12px;">ÂèÇËÄÉÊÉÖÂ†±:</strong>
                    `;

                    for (const source of msg.sources) {
                        html += `
                            <div class="source-item">
                                <div class="source-label">${this.escapeHtml(source.title)}</div>
                                <div class="source-detail">
                                    ${source.type === 'knowledge' ? 'üìù Áü•Ë≠ò' : 'üìÑ „Éâ„Ç≠„É•„É°„É≥„Éà'} 
                                    ‚Ä¢ ${source.timestamp}
                                </div>
                            </div>
                        `;
                    }

                    html += `</div>`;
                }

                html += `
                        <div class="message-time">${msg.timestamp}</div>
                    </div>
                `;

                div.innerHTML = html;
                return div;
            }

            /**
             * Áü•Ë≠òÁôªÈå≤„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
             */
            openMemoryModal() {
                document.getElementById('memoryModal').style.display = 'block';
                document.getElementById('modalOverlay').style.display = 'block';
                document.getElementById('knowledgeTitle').focus();
            }

            /**
             * Áü•Ë≠òÁôªÈå≤„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
             */
            closeMemoryModal() {
                document.getElementById('memoryModal').style.display = 'none';
                document.getElementById('modalOverlay').style.display = 'none';
                document.getElementById('knowledgeTitle').value = '';
                document.getElementById('knowledgeContent').value = '';
                document.getElementById('knowledgeTags').value = '';
            }

            /**
             * Áü•Ë≠ò„Çí‰øùÂ≠ò
             */
            saveMemory() {
                const title = document.getElementById('knowledgeTitle').value.trim();
                const content = document.getElementById('knowledgeContent').value.trim();
                const tagsStr = document.getElementById('knowledgeTags').value.trim();

                if (!title || !content) {
                    alert('„Çø„Ç§„Éà„É´„Å®ÂÜÖÂÆπ„ÅØÂøÖÈ†à„Åß„Åô');
                    return;
                }

                const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];

                const knowledge = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    tags: tags,
                    timestamp: new Date().toLocaleString('ja-JP')
                };

                this.knowledge.push(knowledge);
                this.saveData();

                alert('Áü•Ë≠ò„ÇíÁôªÈå≤„Åó„Åæ„Åó„ÅüÔºÅ');
                this.closeMemoryModal();

                // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
                this.addMessage('user', `Áü•Ë≠ò„ÇíÁôªÈå≤„Åó„Åæ„Åó„ÅüÔºö${title}`);
                this.addMessage('assistant', `„Äå${title}„Äç„ÇíÁü•Ë≠ò„Éô„Éº„Çπ„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ‰ªäÂæå„ÅÆÊ§úÁ¥¢„ÅßÂèÇËÄÉ„Å´„Åï„Çå„Åæ„Åô„ÄÇ`);
            }

            /**
             * „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
             */
            handleFileUpload(event) {
                const files = event.target.files;

                for (const file of files) {
                    if (!this.isValidFile(file)) {
                        alert(`${file.name} „ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`);
                        continue;
                    }

                    const reader = new FileReader();

                    reader.onload = (e) => {
                        const doc = {
                            id: Date.now(),
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            uploadedAt: new Date().toLocaleString('ja-JP'),
                            content: e.target.result // Base64„Ç®„É≥„Ç≥„Éº„Éâ
                        };

                        this.documents.push(doc);
                        this.saveData();

                        alert(`${file.name} „Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ`);
                        this.addMessage('user', `„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ: ${file.name}`);
                        this.addMessage('assistant', `„Äå${file.name}„Äç„ÇíÁü•Ë≠ò„Éô„Éº„Çπ„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ„Åì„ÅÆ„Éï„Ç°„Ç§„É´„Åã„ÇâÊ§úÁ¥¢„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ`);
                    };

                    reader.readAsDataURL(file);
                }

                // „Éï„Ç°„Ç§„É´„Ç§„É≥„Éó„ÉÉ„Éà„Çí„É™„Çª„ÉÉ„Éà
                event.target.value = '';
            }

            /**
             * „Éï„Ç°„Ç§„É´„ÅåÊúâÂäπ„ÅãÁ¢∫Ë™ç
             */
            isValidFile(file) {
                const validTypes = ['application/pdf', 'text/html', 'text/plain'];
                const validExtensions = ['.pdf', '.html', '.txt'];

                const hasValidType = validTypes.includes(file.type);
                const hasValidExtension = validExtensions.some(ext => file.name.endsWith(ext));

                return hasValidType || hasValidExtension;
            }

            /**
             * „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
             */
            showLoading() {
                document.getElementById('loadingIndicator').style.display = 'flex';
            }

            /**
             * „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
             */
            hideLoading() {
                document.getElementById('loadingIndicator').style.display = 'none';
            }

            /**
             * ‰∏ã„Å´„Çπ„ÇØ„É≠„Éº„É´
             */
            scrollToBottom() {
                const container = document.getElementById('messagesContainer');
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 0);
            }

            /**
             * HTML„Ç®„Çπ„Ç±„Éº„Éó
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new AIKnowledgeBase();
        });
    </script>
</body>
</html>
