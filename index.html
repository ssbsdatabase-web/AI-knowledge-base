<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ©Ÿå™¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ« AIæ¤œç´¢</title>

  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- TensorFlow.js + Universal Sentence Encoder -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>

  <!-- WebLLM for in-browser LLM inference -->
  <script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.52/dist/web-llm.js"></script>

  <style>
    /* ===== CSS Reset & Base ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-primary:    #F2F2F7;
      --bg-secondary:  #FFFFFF;
      --bg-tertiary:   #E5E5EA;
      --accent:        #007AFF;
      --accent-dark:   #0056CC;
      --bubble-me:     #007AFF;
      --bubble-ai:     #FFFFFF;
      --text-primary:  #1C1C1E;
      --text-secondary:#6C6C70;
      --text-inverse:  #FFFFFF;
      --border:        #C6C6C8;
      --shadow:        rgba(0,0,0,0.08);
      --shadow-md:     rgba(0,0,0,0.14);
      --radius-lg:     18px;
      --radius-md:     12px;
      --radius-sm:     8px;
      --font:          -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
      --header-h:      56px;
      --input-h:       60px;
      --status-h:      36px;
    }

    html, body {
      height: 100%;
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    /* ===== App Shell ===== */
    #app {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      max-width: 768px;
      margin: 0 auto;
      background: var(--bg-primary);
      position: relative;
    }

    /* ===== Header ===== */
    #header {
      flex-shrink: 0;
      height: var(--header-h);
      background: rgba(255,255,255,0.85);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 0.5px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #header-left { display: flex; align-items: center; gap: 10px; }

    #header-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, #007AFF, #5AC8FA);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(0,122,255,0.3);
    }

    #header-title {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    #header-subtitle {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 1px;
    }

    #header-actions { display: flex; gap: 8px; }

    .header-btn {
      width: 32px; height: 32px;
      border: none;
      background: var(--bg-tertiary);
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      transition: background 0.15s;
      color: var(--accent);
    }
    .header-btn:active { background: var(--border); }

    /* ===== Status Bar ===== */
    #status-bar {
      flex-shrink: 0;
      height: var(--status-h);
      background: var(--bg-secondary);
      border-bottom: 0.5px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 14px;
      gap: 8px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    #status-bar::-webkit-scrollbar { display: none; }

    .status-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      padding: 3px 8px;
      background: var(--bg-primary);
      border-radius: 20px;
      border: 0.5px solid var(--border);
    }
    .status-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #8E8E93;
    }
    .status-dot.green  { background: #34C759; }
    .status-dot.orange { background: #FF9500; }
    .status-dot.red    { background: #FF3B30; }
    .status-dot.pulse  {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity:1; }
      50%      { opacity:0.3; }
    }

    /* ===== Chat Area ===== */
    #chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 12px 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    #chat-area::-webkit-scrollbar { width: 4px; }
    #chat-area::-webkit-scrollbar-track { background: transparent; }
    #chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Date separator */
    .date-sep {
      text-align: center;
      font-size: 11px;
      color: var(--text-secondary);
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .date-sep::before, .date-sep::after {
      content: '';
      flex: 1;
      height: 0.5px;
      background: var(--border);
    }

    /* Message row */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      max-width: 100%;
      animation: fadeSlide 0.25s ease;
    }
    @keyframes fadeSlide {
      from { opacity:0; transform: translateY(8px); }
      to   { opacity:1; transform: translateY(0); }
    }
    .msg-row.me  { flex-direction: row-reverse; }
    .msg-row.ai  { flex-direction: row; }

    /* Avatar */
    .avatar {
      width: 28px; height: 28px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      background: linear-gradient(135deg, #007AFF, #5AC8FA);
      color: white;
      font-weight: 600;
    }
    .avatar.me { background: linear-gradient(135deg, #34C759, #30D158); }

    /* Bubble */
    .bubble {
      max-width: min(72%, 520px);
      padding: 10px 14px;
      border-radius: var(--radius-lg);
      font-size: 15px;
      line-height: 1.55;
      word-break: break-word;
      position: relative;
      box-shadow: 0 1px 4px var(--shadow);
    }
    .bubble.me {
      background: var(--bubble-me);
      color: var(--text-inverse);
      border-bottom-right-radius: 4px;
    }
    .bubble.ai {
      background: var(--bubble-ai);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
      border: 0.5px solid var(--border);
    }

    /* Timestamp under bubble */
    .msg-meta {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 3px;
      padding: 0 4px;
      text-align: right;
    }
    .msg-row.ai .msg-meta { text-align: left; }

    /* Bubble inner elements */
    .bubble-answer {
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .bubble-sources {
      border-top: 0.5px solid var(--border);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .source-card {
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      border: 0.5px solid var(--border);
      font-size: 12px;
      line-height: 1.5;
    }
    .source-card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .source-icon {
      font-size: 14px;
      flex-shrink: 0;
    }
    .source-filename {
      font-weight: 600;
      color: var(--accent);
      font-size: 12px;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .source-page {
      font-size: 11px;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      padding: 1px 6px;
      border-radius: 10px;
      flex-shrink: 0;
    }
    .source-excerpt {
      color: var(--text-secondary);
      font-size: 11.5px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .source-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 5px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .source-date {
      font-size: 10px;
      color: var(--text-secondary);
    }
    .source-link {
      font-size: 11px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 3px 8px;
      background: rgba(0,122,255,0.08);
      border-radius: 10px;
    }
    .source-link:active { background: rgba(0,122,255,0.18); }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 10px 14px;
      background: var(--bubble-ai);
      border-radius: var(--radius-lg);
      border-bottom-left-radius: 4px;
      border: 0.5px solid var(--border);
      width: fit-content;
      box-shadow: 0 1px 4px var(--shadow);
    }
    .typing-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: typingBounce 1.2s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%,60%,100% { transform: translateY(0); }
      30%          { transform: translateY(-5px); }
    }

    /* System message */
    .sys-msg {
      text-align: center;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 4px 12px;
      background: rgba(142,142,147,0.12);
      border-radius: 10px;
      margin: 4px auto;
      max-width: 90%;
    }

    /* ===== Input Area ===== */
    #input-area {
      flex-shrink: 0;
      background: rgba(255,255,255,0.92);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-top: 0.5px solid var(--border);
      padding: 8px 12px;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
    }

    #input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    #attach-btn {
      width: 36px; height: 36px;
      border: none;
      background: var(--bg-tertiary);
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      transition: background 0.15s;
      color: var(--accent);
    }
    #attach-btn:active { background: var(--border); }

    #msg-input-wrap {
      flex: 1;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 20px;
      display: flex;
      align-items: flex-end;
      padding: 6px 12px;
      min-height: 36px;
      max-height: 120px;
      overflow: hidden;
      transition: border-color 0.15s;
    }
    #msg-input-wrap:focus-within { border-color: var(--accent); }

    #msg-input {
      flex: 1;
      border: none;
      background: transparent;
      font-family: var(--font);
      font-size: 15px;
      color: var(--text-primary);
      resize: none;
      outline: none;
      line-height: 1.45;
      max-height: 108px;
      overflow-y: auto;
    }
    #msg-input::placeholder { color: var(--text-secondary); }

    #send-btn {
      width: 36px; height: 36px;
      border: none;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(0,122,255,0.35);
    }
    #send-btn:active { background: var(--accent-dark); transform: scale(0.93); }
    #send-btn:disabled { background: var(--border); box-shadow: none; cursor: not-allowed; }
    #send-btn svg { width: 18px; height: 18px; fill: white; }

    /* ===== Modals ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 200;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      animation: overlayIn 0.2s ease;
    }
    @keyframes overlayIn { from { opacity:0; } to { opacity:1; } }

    .modal-sheet {
      background: var(--bg-secondary);
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-width: 768px;
      max-height: 85dvh;
      overflow-y: auto;
      padding: 0 0 max(20px, env(safe-area-inset-bottom));
      animation: sheetUp 0.3s cubic-bezier(0.32,0.72,0,1);
    }
    @keyframes sheetUp {
      from { transform: translateY(100%); }
      to   { transform: translateY(0); }
    }

    .modal-handle {
      width: 36px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 10px auto 0;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 600;
      padding: 16px 20px 12px;
      border-bottom: 0.5px solid var(--border);
    }

    .modal-body { padding: 16px 20px; }

    /* Settings modal */
    .settings-section { margin-bottom: 20px; }
    .settings-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      margin-bottom: 4px;
      font-size: 15px;
    }
    .settings-input {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      font-size: 14px;
      font-family: var(--font);
      width: 100%;
      background: var(--bg-primary);
      color: var(--text-primary);
      outline: none;
    }
    .settings-input:focus { border-color: var(--accent); }

    .btn-primary {
      width: 100%;
      padding: 13px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.15s;
      margin-top: 4px;
    }
    .btn-primary:active { background: var(--accent-dark); }
    .btn-primary:disabled { background: var(--border); cursor: not-allowed; }

    .btn-secondary {
      width: 100%;
      padding: 13px;
      background: var(--bg-primary);
      color: var(--accent);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.15s;
      margin-top: 8px;
    }
    .btn-secondary:active { background: var(--bg-tertiary); }

    /* Repository modal */
    #repo-list { display: flex; flex-direction: column; gap: 8px; }

    .repo-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      border: 0.5px solid var(--border);
    }
    .repo-icon { font-size: 22px; flex-shrink: 0; }
    .repo-info { flex: 1; overflow: hidden; }
    .repo-name {
      font-size: 13px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .repo-meta { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }
    .repo-badge {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 10px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .badge-indexed { background: rgba(52,199,89,0.15); color: #34C759; }
    .badge-pending { background: rgba(255,149,0,0.15); color: #FF9500; }
    .badge-error   { background: rgba(255,59,48,0.15);  color: #FF3B30; }

    /* Progress bar */
    .progress-wrap {
      background: var(--bg-tertiary);
      border-radius: 4px;
      height: 4px;
      overflow: hidden;
      margin-top: 4px;
    }
    .progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Empty state */
    #empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px 24px;
      text-align: center;
    }
    #empty-icon {
      font-size: 56px;
      line-height: 1;
    }
    #empty-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    #empty-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      max-width: 280px;
    }
    .quick-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 8px;
    }
    .quick-chip {
      padding: 7px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
      color: var(--accent);
      font-weight: 500;
    }
    .quick-chip:active { background: var(--bg-tertiary); }

    /* File upload overlay */
    #drop-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,122,255,0.15);
      border: 3px dashed var(--accent);
      border-radius: 20px;
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }
    #drop-overlay.active { display: flex; }
    #drop-overlay-icon { font-size: 48px; }

    /* Toast */
    #toast {
      position: fixed;
      bottom: max(80px, calc(var(--input-h) + 20px + env(safe-area-inset-bottom)));
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(28,28,30,0.9);
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      z-index: 400;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      white-space: nowrap;
      max-width: 90vw;
      text-align: center;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Scrollbar hide on mobile */
    @media (max-width: 480px) {
      .bubble { max-width: 82%; }
      #header-title { font-size: 16px; }
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary:    #1C1C1E;
        --bg-secondary:  #2C2C2E;
        --bg-tertiary:   #3A3A3C;
        --bubble-ai:     #2C2C2E;
        --text-primary:  #FFFFFF;
        --text-secondary:#AEAEB2;
        --border:        #38383A;
        --shadow:        rgba(0,0,0,0.3);
      }
      #header { background: rgba(28,28,30,0.85); }
      #input-area { background: rgba(28,28,30,0.92); }
      .source-card { background: var(--bg-tertiary); }
      .quick-chip { background: var(--bg-secondary); }
    }
  </style>
</head>
<body>

<!-- Drop overlay -->
<div id="drop-overlay">
  <div id="drop-overlay-icon">ğŸ“„</div>
  <div>PDFã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç™»éŒ²</div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Main App -->
<div id="app">

  <!-- Header -->
  <div id="header">
    <div id="header-left">
      <div id="header-icon">ğŸ™ï¸</div>
      <div>
        <div id="header-title">æ©Ÿå™¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ« AIæ¤œç´¢</div>
        <div id="header-subtitle">æ”¾é€ãƒ»éŸ³éŸ¿æ©Ÿå™¨ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹</div>
      </div>
    </div>
    <div id="header-actions">
      <button class="header-btn" onclick="openRepoModal()" title="ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†">ğŸ“</button>
      <button class="header-btn" onclick="openSettingsModal()" title="è¨­å®š">âš™ï¸</button>
    </div>
  </div>

  <!-- Status Bar -->
  <div id="status-bar">
    <div class="status-chip">
      <div class="status-dot" id="llm-dot"></div>
      <span id="llm-status-text">LLM åˆæœŸåŒ–ä¸­...</span>
    </div>
    <div class="status-chip">
      <div class="status-dot" id="use-dot"></div>
      <span id="use-status-text">åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ« æœªãƒ­ãƒ¼ãƒ‰</span>
    </div>
    <div class="status-chip">
      <div class="status-dot" id="db-dot"></div>
      <span id="db-status-text">DB: 0ä»¶</span>
    </div>
  </div>

  <!-- Chat Area -->
  <div id="chat-area">
    <!-- Empty state -->
    <div id="empty-state">
      <div id="empty-icon">ğŸšï¸</div>
      <div id="empty-title">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«AIæ¤œç´¢</div>
      <div id="empty-desc">PDFãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ç™»éŒ²ã—ã¦ã€è‡ªç„¶è¨€èªã§æ©Ÿå™¨ã®ä»•æ§˜ãƒ»æ“ä½œæ–¹æ³•ã‚’å³åº§ã«æ¤œç´¢ã§ãã¾ã™ã€‚</div>
      <div class="quick-chips">
        <div class="quick-chip" onclick="quickQuery('é€£ç¶šä½¿ç”¨æ™‚é–“ã¯ï¼Ÿ')">ğŸ”‹ é€£ç¶šä½¿ç”¨æ™‚é–“ã¯ï¼Ÿ</div>
        <div class="quick-chip" onclick="quickQuery('å‘¨æ³¢æ•°å¸¯åŸŸã‚’æ•™ãˆã¦')">ğŸ“¡ å‘¨æ³¢æ•°å¸¯åŸŸã‚’æ•™ãˆã¦</div>
        <div class="quick-chip" onclick="quickQuery('æ¥ç¶šæ–¹æ³•ã¯ï¼Ÿ')">ğŸ”Œ æ¥ç¶šæ–¹æ³•ã¯ï¼Ÿ</div>
        <div class="quick-chip" onclick="quickQuery('ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°')">ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div id="input-area">
    <div id="input-row">
      <button id="attach-btn" onclick="triggerFileInput()" title="PDFã‚’è¿½åŠ ">ğŸ“</button>
      <div id="msg-input-wrap">
        <textarea id="msg-input"
          placeholder="æ©Ÿå™¨ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„..."
          rows="1"
          onkeydown="handleKeydown(event)"
          oninput="autoResize(this)"></textarea>
      </div>
      <button id="send-btn" onclick="sendMessage()" disabled>
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- Hidden file input -->
<input type="file" id="file-input" accept=".pdf,.txt,.md" multiple style="display:none" onchange="handleFileSelect(event)" />

<!-- ===== MODALS ===== -->

<!-- Settings Modal -->
<div id="settings-modal" style="display:none">
  <div class="modal-overlay" onclick="closeModal('settings-modal')">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div class="modal-handle"></div>
      <div class="modal-title">âš™ï¸ è¨­å®š</div>
      <div class="modal-body">
        <div class="settings-section">
          <div class="settings-label">LLM è¨­å®š</div>
          <div style="margin-bottom:8px;padding:10px;background:var(--bg-primary);border-radius:8px;border-left:3px solid var(--accent)">
            <div style="font-size:13px;color:var(--text-secondary);line-height:1.6">
              âœ… ãƒ–ãƒ©ã‚¦ã‚¶å†…LLMï¼ˆWebLLMï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚<br/>
              ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã§ã€å®Œå…¨ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å‹•ä½œã—ã¾ã™ã€‚<br/>
              åˆå›èµ·å‹•æ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆç´„2GBï¼‰ã€‚
            </div>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-label">æ¤œç´¢è¨­å®š</div>
          <div class="settings-row">
            <span>æ¤œç´¢çµæœä»¶æ•°</span>
            <input type="number" id="top-k" value="5" min="1" max="20"
              style="width:60px;text-align:center;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:14px;background:var(--bg-primary);color:var(--text-primary);" />
          </div>
          <div class="settings-row">
            <span>é¡ä¼¼åº¦ã—ãã„å€¤</span>
            <input type="number" id="sim-threshold" value="0.3" min="0" max="1" step="0.05"
              style="width:70px;text-align:center;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:14px;background:var(--bg-primary);color:var(--text-primary);" />
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-label">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
          <button class="btn-secondary" onclick="exportDB()">ğŸ’¾ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="btn-secondary" onclick="importDBFile()">ğŸ“¥ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="btn-secondary" style="color:#FF3B30;border-color:#FF3B30" onclick="clearDB()">ğŸ—‘ï¸ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å…¨å‰Šé™¤</button>
        </div>

        <button class="btn-primary" onclick="saveSettings();closeModal('settings-modal')">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- Repository Modal -->
<div id="repo-modal" style="display:none">
  <div class="modal-overlay" onclick="closeModal('repo-modal')">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div class="modal-handle"></div>
      <div class="modal-title">ğŸ“ ç™»éŒ²ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</div>
      <div class="modal-body">
        <div style="display:flex;gap:8px;margin-bottom:14px">
          <button class="btn-primary" style="flex:1" onclick="triggerFileInput()">ï¼‹ PDFã‚’è¿½åŠ </button>
        </div>
        <div id="repo-list">
          <div style="text-align:center;color:var(--text-secondary);font-size:14px;padding:20px">
            ãƒ•ã‚¡ã‚¤ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Import DB input -->
<input type="file" id="import-db-input" accept=".json" style="display:none" onchange="importDB(event)" />

<script>
// ============================================================
//  GLOBAL STATE
// ============================================================
const STATE = {
  topK:          5,
  simThreshold:  0.3,
  llmReady:      false,
  useModelLoaded:false,
  isProcessing:  false,
  llmEngine:     null,
};

// Vector DB: array of chunk objects
let vectorDB = [];
let useModel  = null;  // Universal Sentence Encoder instance

// ============================================================
//  INIT
// ============================================================
window.addEventListener('DOMContentLoaded', async () => {
  loadSettings();
  updateSendBtn();
  setupDragDrop();
  await loadUSEModel();
  await initWebLLM();
  loadDBFromStorage();
  updateDBStatus();
  updateRepoList();
});

// ============================================================
//  SETTINGS
// ============================================================
function loadSettings() {
  const s = JSON.parse(localStorage.getItem('kbs_settings') || '{}');
  STATE.topK          = s.topK          || 5;
  STATE.simThreshold  = s.simThreshold  || 0.3;

  document.getElementById('top-k').value            = STATE.topK;
  document.getElementById('sim-threshold').value    = STATE.simThreshold;
}

function saveSettings() {
  STATE.topK          = parseInt(document.getElementById('top-k').value) || 5;
  STATE.simThreshold  = parseFloat(document.getElementById('sim-threshold').value) || 0.3;
  localStorage.setItem('kbs_settings', JSON.stringify({
    topK: STATE.topK, simThreshold: STATE.simThreshold,
  }));
  showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

// ============================================================
//  WEBLLM INITIALIZATION
// ============================================================
async function initWebLLM() {
  const dot  = document.getElementById('llm-dot');
  const text = document.getElementById('llm-status-text');
  dot.className = 'status-dot pulse orange';
  text.textContent = 'LLM åˆæœŸåŒ–ä¸­...';

  try {
    // Initialize WebLLM engine
    const selectedModel = 'Phi-3-mini-4k-instruct-q4f32_1';
    STATE.llmEngine = new webllm.MLCEngine({
      model: selectedModel,
      appConfig: new webllm.AppConfig({
        log_level: 'warn',
      }),
    });

    // Load model (this will download ~2GB on first run)
    await STATE.llmEngine.reload(selectedModel);
    STATE.llmReady = true;
    dot.className = 'status-dot green';
    text.textContent = 'LLM æº–å‚™å®Œäº†';
  } catch(e) {
    console.error('WebLLM init error:', e);
    dot.className = 'status-dot orange';
    text.textContent = 'LLM ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯';
    STATE.llmReady = false;
  }
}

// ============================================================
//  UNIVERSAL SENTENCE ENCODER (Embedding)
// ============================================================
async function loadUSEModel() {
  const dot  = document.getElementById('use-dot');
  const text = document.getElementById('use-status-text');
  dot.className = 'status-dot pulse orange';
  text.textContent = 'åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ« ãƒ­ãƒ¼ãƒ‰ä¸­...';
  try {
    useModel = await use.load();
    STATE.useModelLoaded = true;
    dot.className = 'status-dot green';
    text.textContent = 'åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ« æº–å‚™å®Œäº†';
  } catch(e) {
    dot.className = 'status-dot orange';
    text.textContent = 'åŸ‹ã‚è¾¼ã¿: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨';
    useModel = null;
  }
}

async function getEmbedding(text) {
  if (useModel) {
    const emb = await useModel.embed([text]);
    const arr = await emb.data();
    emb.dispose();
    return Array.from(arr);
  }
  return simpleFallbackEmbedding(text);
}

function simpleFallbackEmbedding(text) {
  const dim = 512;
  const vec = new Float32Array(dim).fill(0);
  const t = text.toLowerCase();
  for (let i = 0; i < t.length - 1; i++) {
    const code = (t.charCodeAt(i) * 31 + t.charCodeAt(i+1)) % dim;
    vec[code] += 1;
  }
  let norm = 0;
  for (let v of vec) norm += v * v;
  norm = Math.sqrt(norm) || 1;
  return Array.from(vec).map(v => v / norm);
}

function cosineSimilarity(a, b) {
  let dot = 0, na = 0, nb = 0;
  for (let i = 0; i < a.length; i++) {
    dot += a[i] * b[i];
    na  += a[i] * a[i];
    nb  += b[i] * b[i];
  }
  return dot / (Math.sqrt(na) * Math.sqrt(nb) || 1);
}

// ============================================================
//  PDF PARSING
// ============================================================
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function parsePDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const totalPages = pdf.numPages;
  const pages = [];

  for (let p = 1; p <= totalPages; p++) {
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const rawText = content.items.map(i => i.str).join(' ').replace(/\s+/g,' ').trim();
    if (rawText.length > 20) {
      pages.push({ page: p, text: rawText });
    }
  }
  return pages;
}

function chunkText(text, maxLen = 400, overlap = 80) {
  const chunks = [];
  const sentences = text.split(/(?<=[ã€‚ï¼ï¼Ÿ\.\!\?])\s*|(?:\n{2,})/);
  let current = '';
  for (const s of sentences) {
    if ((current + s).length > maxLen && current.length > 0) {
      chunks.push(current.trim());
      const words = current.split(' ');
      current = words.slice(-Math.floor(overlap/10)).join(' ') + ' ' + s;
    } else {
      current += (current ? ' ' : '') + s;
    }
  }
  if (current.trim().length > 20) chunks.push(current.trim());
  return chunks;
}

function extractHeading(text) {
  const m = text.match(/^(ç¬¬\s*\d+\s*[ç« ç¯€æ¡]|Chapter\s*\d+|\d+\.\d*\s+[^\s]{2,20})/i);
  return m ? m[0].trim() : '';
}

function autoTag(text, filename) {
  const tags = {};
  const modelMatch = text.match(/[A-Z]{1,5}[-\s]?\d{2,6}[A-Z0-9\-]*/);
  if (modelMatch) tags.model = modelMatch[0];
  const mfr = filename.split(/[-_]/)[0];
  if (mfr && mfr.length > 1) tags.manufacturer = mfr;
  const cats = {
    'ãƒã‚¤ã‚¯': ['ãƒã‚¤ã‚¯','mic','microphone'],
    'ãƒŸã‚­ã‚µãƒ¼': ['ãƒŸã‚­ã‚µãƒ¼','mixer'],
    'ã‚¢ãƒ³ãƒ—': ['ã‚¢ãƒ³ãƒ—','amplifier','amp'],
    'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼': ['ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼','speaker'],
    'ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼': ['ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼','recorder'],
    'ã‚«ãƒ¡ãƒ©': ['ã‚«ãƒ¡ãƒ©','camera'],
    'ã‚¹ã‚¤ãƒƒãƒãƒ£ãƒ¼': ['ã‚¹ã‚¤ãƒƒãƒãƒ£ãƒ¼','switcher'],
    'ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹': ['ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹','wireless'],
  };
  for (const [cat, kws] of Object.entries(cats)) {
    if (kws.some(k => text.toLowerCase().includes(k.toLowerCase()))) {
      tags.category = cat; break;
    }
  }
  return tags;
}

// ============================================================
//  INDEXING
// ============================================================
async function indexFile(file, githubMeta = null) {
  const filename = file.name || (githubMeta && githubMeta.name) || 'unknown';
  const filepath = githubMeta ? githubMeta.path : filename;
  const addedAt  = githubMeta ? githubMeta.addedAt : new Date().toISOString();
  const fileSize = file.size;

  if (vectorDB.some(c => c.filename === filename)) {
    showToast(`âš ï¸ ${filename} ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™`);
    return 0;
  }

  let pages = [];
  if (filename.endsWith('.pdf')) {
    pages = await parsePDF(file);
  } else {
    const text = await file.text();
    pages = [{ page: 1, text }];
  }

  let chunkCount = 0;
  for (const { page, text } of pages) {
    const chunks = chunkText(text);
    for (const chunk of chunks) {
      if (chunk.length < 30) continue;
      const embedding = await getEmbedding(chunk);
      const tags = autoTag(chunk, filename);
      const heading = extractHeading(chunk);
      vectorDB.push({
        id:       `${filename}_p${page}_${chunkCount}`,
        filename,
        filepath,
        page,
        chapter:  heading,
        text:     chunk,
        embedding,
        tags,
        addedAt,
        fileSize,
      });
      chunkCount++;
    }
  }

  saveDBToStorage();
  updateDBStatus();
  updateRepoList();
  return chunkCount;
}

// ============================================================
//  VECTOR SEARCH
// ============================================================
async function search(query, topK = null, threshold = null) {
  topK      = topK      || STATE.topK;
  threshold = threshold || STATE.simThreshold;

  if (vectorDB.length === 0) return [];

  const qEmb = await getEmbedding(query);

  const scored = vectorDB.map(chunk => ({
    ...chunk,
    score: cosineSimilarity(qEmb, chunk.embedding),
  }));

  scored.sort((a, b) => b.score - a.score);

  const seen = new Set();
  const results = [];
  for (const r of scored) {
    if (r.score < threshold) break;
    const key = `${r.filename}_${r.page}`;
    if (!seen.has(key)) {
      seen.add(key);
      results.push(r);
    }
    if (results.length >= topK) break;
  }
  return results;
}

// ============================================================
//  WEBLLM AI RESPONSE
// ============================================================
async function askWebLLM(question, contexts) {
  if (!STATE.llmReady || !STATE.llmEngine) {
    return generateFallbackAnswer(question, contexts);
  }

  const contextText = contexts.map((c, i) =>
    `[å‚ç…§${i+1}] ãƒ•ã‚¡ã‚¤ãƒ«: ${c.filename} / ãƒšãƒ¼ã‚¸: ${c.page}\n${c.text}`
  ).join('\n\n');

  const prompt = `ã‚ãªãŸã¯æ”¾é€ãƒ»éŸ³éŸ¿æ©Ÿå™¨ã®å°‚é–€å®¶AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®å‚ç…§è³‡æ–™ã‚’ã‚‚ã¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«æ—¥æœ¬èªã§æ­£ç¢ºãƒ»ç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
å‚ç…§è³‡æ–™ã«ãªã„æƒ…å ±ã¯ã€Œè³‡æ–™ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚

ã€å‚ç…§è³‡æ–™ã€‘
${contextText}

ã€è³ªå•ã€‘
${question}

ã€å›ç­”å½¢å¼ã€‘
- çµè«–ã‚’æœ€åˆã«è¿°ã¹ã‚‹
- æ•°å€¤ãƒ»ä»•æ§˜ã¯æ­£ç¢ºã«å¼•ç”¨ã™ã‚‹
- å‚ç…§ã—ãŸè³‡æ–™åã¨ãƒšãƒ¼ã‚¸ã‚’æ˜è¨˜ã™ã‚‹
- 200å­—ä»¥å†…ã§ç°¡æ½”ã«`;

  try {
    let response = '';
    const asyncChunkGenerator = await STATE.llmEngine.chat.completions.create({
      messages: [{ role: 'user', content: prompt }],
      stream: true,
    });

    for await (const chunk of asyncChunkGenerator) {
      if (chunk.choices[0].delta.content) {
        response += chunk.choices[0].delta.content;
      }
    }
    return response.trim() || 'å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  } catch(e) {
    console.error('WebLLM error:', e);
    return generateFallbackAnswer(question, contexts);
  }
}

function generateFallbackAnswer(question, contexts) {
  if (contexts.length === 0) {
    return 'é–¢é€£ã™ã‚‹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚PDFãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ç™»éŒ²ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
  }
  const top = contexts[0];
  const sentences = top.text.split(/[ã€‚ï¼ï¼Ÿ\.\!\?]/).filter(s => s.trim().length > 10);
  const relevant = sentences.find(s =>
    question.split(/\s+/).some(w => s.includes(w))
  ) || sentences[0] || top.text.slice(0, 150);

  return `ã€å‚ç…§è³‡æ–™ã‚ˆã‚Šã€‘\n${relevant.trim()}â€¦`;
}

// ============================================================
//  CHAT UI
// ============================================================
function hideEmptyState() {
  const el = document.getElementById('empty-state');
  if (el) el.remove();
}

function addDateSep() {
  const now = new Date();
  const label = now.toLocaleDateString('ja-JP', { year:'numeric', month:'long', day:'numeric', weekday:'short' });
  const sep = document.createElement('div');
  sep.className = 'date-sep';
  sep.textContent = label;
  document.getElementById('chat-area').appendChild(sep);
}

function addSysMsg(text) {
  const el = document.createElement('div');
  el.className = 'sys-msg';
  el.textContent = text;
  document.getElementById('chat-area').appendChild(el);
  scrollToBottom();
}

function addUserBubble(text) {
  hideEmptyState();
  const area = document.getElementById('chat-area');
  const timeStr = new Date().toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit' });

  const row = document.createElement('div');
  row.className = 'msg-row me';
  row.innerHTML = `
    <div>
      <div class="bubble me">${escapeHtml(text)}</div>
      <div class="msg-meta">${timeStr}</div>
    </div>
    <div class="avatar me">ğŸ‘¤</div>
  `;
  area.appendChild(row);
  scrollToBottom();
}

function addTypingIndicator() {
  const area = document.getElementById('chat-area');
  const row = document.createElement('div');
  row.className = 'msg-row ai';
  row.id = 'typing-row';
  row.innerHTML = `
    <div class="avatar">ğŸ¤–</div>
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  area.appendChild(row);
  scrollToBottom();
  return row;
}

function removeTypingIndicator() {
  const el = document.getElementById('typing-row');
  if (el) el.remove();
}

function addAIBubble(answer, sources) {
  const area = document.getElementById('chat-area');
  const timeStr = new Date().toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit' });

  let sourcesHtml = '';
  if (sources && sources.length > 0) {
    const cards = sources.map(s => {
      const addedDate = s.addedAt
        ? new Date(s.addedAt).toLocaleString('ja-JP', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' })
        : 'ä¸æ˜';
      const excerpt = escapeHtml(s.text.slice(0, 120)) + (s.text.length > 120 ? 'â€¦' : '');
      const chapterBadge = s.chapter ? `<span style="font-size:10px;color:var(--text-secondary);margin-left:4px">${escapeHtml(s.chapter)}</span>` : '';
      const modelTag = s.tags && s.tags.model ? `<span style="font-size:10px;background:rgba(0,122,255,0.1);color:var(--accent);padding:1px 5px;border-radius:6px;margin-right:4px">${escapeHtml(s.tags.model)}</span>` : '';
      const catTag   = s.tags && s.tags.category ? `<span style="font-size:10px;background:rgba(52,199,89,0.1);color:#34C759;padding:1px 5px;border-radius:6px">${escapeHtml(s.tags.category)}</span>` : '';
      const scoreStr = (s.score * 100).toFixed(0);

      return `
        <div class="source-card">
          <div class="source-card-header">
            <span class="source-icon">ğŸ“„</span>
            <span class="source-filename">${escapeHtml(s.filename)}</span>
            <span class="source-page">p.${s.page}</span>
          </div>
          ${modelTag}${catTag}${chapterBadge}
          <div class="source-excerpt" style="margin-top:4px">${excerpt}</div>
          <div class="source-meta">
            <span class="source-date">ğŸ“… ç™»éŒ²: ${addedDate} &nbsp;|&nbsp; é¡ä¼¼åº¦: ${scoreStr}%</span>
          </div>
        </div>`;
    }).join('');

    sourcesHtml = `
      <div class="bubble-sources">
        <div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">ğŸ“š å‚ç…§å…ƒ (${sources.length}ä»¶)</div>
        ${cards}
      </div>`;
  }

  const row = document.createElement('div');
  row.className = 'msg-row ai';
  row.innerHTML = `
    <div class="avatar">ğŸ¤–</div>
    <div>
      <div class="bubble ai">
        <div class="bubble-answer">${formatAnswer(answer)}</div>
        ${sourcesHtml}
      </div>
      <div class="msg-meta">${timeStr}</div>
    </div>
  `;
  area.appendChild(row);
  scrollToBottom();
}

function formatAnswer(text) {
  return escapeHtml(text)
    .replace(/\n/g, '<br>')
    .replace(/ã€(.+?)ã€‘/g, '<strong>ã€$1ã€‘</strong>')
    .replace(/(\d+(?:\.\d+)?(?:æ™‚é–“|åˆ†|ç§’|Hz|kHz|MHz|dB|W|mW|V|mV|Î©|m|cm|mm|kg|g|ch|ch))/g,
      '<span style="color:var(--accent);font-weight:600">$1</span>');
}

function escapeHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

function scrollToBottom() {
  const area = document.getElementById('chat-area');
  requestAnimationFrame(() => {
    area.scrollTop = area.scrollHeight;
  });
}

// ============================================================
//  SEND MESSAGE
// ============================================================
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const query = input.value.trim();
  if (!query || STATE.isProcessing) return;

  STATE.isProcessing = true;
  input.value = '';
  autoResize(input);
  updateSendBtn();

  addUserBubble(query);
  const typingRow = addTypingIndicator();

  try {
    if (vectorDB.length === 0) {
      removeTypingIndicator();
      addAIBubble(
        'ã¾ã ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nğŸ“ ãƒœã‚¿ãƒ³ã¾ãŸã¯å³ä¸Šã®ğŸ“ãƒœã‚¿ãƒ³ã‹ã‚‰PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚',
        []
      );
      return;
    }

    const results = await search(query);
    removeTypingIndicator();

    if (results.length === 0) {
      addAIBubble(
        `ã€Œ${query}ã€ã«é–¢é€£ã™ã‚‹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nåˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è©¦ã™ã‹ã€é–¢é€£ã™ã‚‹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`,
        []
      );
      return;
    }

    const answer = await askWebLLM(query, results);
    addAIBubble(answer, results);

  } catch(e) {
    removeTypingIndicator();
    addAIBubble(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`, []);
  } finally {
    STATE.isProcessing = false;
    updateSendBtn();
  }
}

function quickQuery(text) {
  document.getElementById('msg-input').value = text;
  autoResize(document.getElementById('msg-input'));
  updateSendBtn();
  sendMessage();
}

// ============================================================
//  INPUT HANDLING
// ============================================================
function handleKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 108) + 'px';
  updateSendBtn();
}

function updateSendBtn() {
  const btn = document.getElementById('send-btn');
  const val = document.getElementById('msg-input').value.trim();
  btn.disabled = !val || STATE.isProcessing;
}

// ============================================================
//  FILE HANDLING
// ============================================================
function triggerFileInput() {
  document.getElementById('file-input').click();
}

async function handleFileSelect(event) {
  const files = Array.from(event.target.files);
  event.target.value = '';
  await processFiles(files);
}

async function processFiles(files) {
  if (files.length === 0) return;
  hideEmptyState();

  const validFiles = files.filter(f =>
    f.name.endsWith('.pdf') || f.name.endsWith('.txt') || f.name.endsWith('.md')
  );

  if (validFiles.length === 0) {
    showToast('PDFãƒ»TXTãƒ»MDãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™');
    return;
  }

  addSysMsg(`ğŸ“„ ${validFiles.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...`);

  let total = 0;
  for (const file of validFiles) {
    addSysMsg(`âš™ï¸ ${file.name} ã‚’è§£æä¸­...`);
    try {
      const count = await indexFile(file);
      total += count;
      addSysMsg(`âœ… ${file.name}: ${count}ãƒãƒ£ãƒ³ã‚¯ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
    } catch(e) {
      addSysMsg(`âŒ ${file.name}: ã‚¨ãƒ©ãƒ¼ (${e.message})`);
    }
  }

  addSysMsg(`ğŸ‰ å®Œäº†: åˆè¨ˆ${total}ãƒãƒ£ãƒ³ã‚¯ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«è¿½åŠ ã—ã¾ã—ãŸ`);
  updateRepoList();
  closeModal('repo-modal');
}

function setupDragDrop() {
  const overlay = document.getElementById('drop-overlay');
  let dragCounter = 0;

  document.addEventListener('dragenter', e => {
    e.preventDefault();
    dragCounter++;
    overlay.classList.add('active');
  });
  document.addEventListener('dragleave', e => {
    dragCounter--;
    if (dragCounter <= 0) { dragCounter = 0; overlay.classList.remove('active'); }
  });
  document.addEventListener('dragover', e => e.preventDefault());
  document.addEventListener('drop', async e => {
    e.preventDefault();
    dragCounter = 0;
    overlay.classList.remove('active');
    const files = Array.from(e.dataTransfer.files);
    await processFiles(files);
  });
}

// ============================================================
//  VECTOR DB PERSISTENCE
// ============================================================
function saveDBToStorage() {
  try {
    const data = vectorDB.map(c => ({
      ...c,
      embedding: Array.from(c.embedding),
    }));
    sessionStorage.setItem('kbs_vectordb', JSON.stringify(data));
  } catch(e) {
    console.warn('SessionStorage full');
  }
}

function loadDBFromStorage() {
  try {
    const raw = sessionStorage.getItem('kbs_vectordb');
    if (raw) {
      const data = JSON.parse(raw);
      vectorDB = data.map(c => ({ ...c, embedding: c.embedding }));
      if (vectorDB.length > 0) {
        addSysMsg(`ğŸ“‚ å‰å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ ${vectorDB.length}ãƒãƒ£ãƒ³ã‚¯ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
      }
    }
  } catch(e) {
    vectorDB = [];
  }
}

function updateDBStatus() {
  const dot  = document.getElementById('db-dot');
  const text = document.getElementById('db-status-text');
  const files = new Set(vectorDB.map(c => c.filename)).size;
  if (vectorDB.length > 0) {
    dot.className = 'status-dot green';
    text.textContent = `DB: ${vectorDB.length}ä»¶ (${files}ãƒ•ã‚¡ã‚¤ãƒ«)`;
  } else {
    dot.className = 'status-dot';
    text.textContent = 'DB: 0ä»¶';
  }
}

// ============================================================
//  REPO LIST UI
// ============================================================
function updateRepoList() {
  const list = document.getElementById('repo-list');
  const files = {};
  for (const c of vectorDB) {
    if (!files[c.filename]) {
      files[c.filename] = { filename: c.filename, filepath: c.filepath, addedAt: c.addedAt, chunks: 0, fileSize: c.fileSize };
    }
    files[c.filename].chunks++;
  }

  const entries = Object.values(files);
  if (entries.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:var(--text-secondary);font-size:14px;padding:20px">ãƒ•ã‚¡ã‚¤ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }

  list.innerHTML = entries.map(f => {
    const date = f.addedAt
      ? new Date(f.addedAt).toLocaleString('ja-JP', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' })
      : 'ä¸æ˜';
    const size = f.fileSize ? formatBytes(f.fileSize) : '';
    return `
      <div class="repo-item">
        <div class="repo-icon">ğŸ“„</div>
        <div class="repo-info">
          <div class="repo-name">${escapeHtml(f.filename)}</div>
          <div class="repo-meta">ç™»éŒ²: ${date} &nbsp;|&nbsp; ${f.chunks}ãƒãƒ£ãƒ³ã‚¯${size ? ' | ' + size : ''}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
          <span class="repo-badge badge-indexed">ç™»éŒ²æ¸ˆ</span>
          <button onclick="removeFile('${escapeHtml(f.filename)}')" style="font-size:10px;color:#FF3B30;background:none;border:none;cursor:pointer;padding:0">å‰Šé™¤</button>
        </div>
      </div>`;
  }).join('');
}

function removeFile(filename) {
  if (!confirm(`ã€Œ${filename}ã€ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  vectorDB = vectorDB.filter(c => c.filename !== filename);
  saveDBToStorage();
  updateDBStatus();
  updateRepoList();
  showToast(`${filename} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + 'B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + 'KB';
  return (bytes/1024/1024).toFixed(1) + 'MB';
}

// ============================================================
//  EXPORT / IMPORT DB
// ============================================================
function exportDB() {
  const data = vectorDB.map(c => ({ ...c, embedding: Array.from(c.embedding) }));
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `kbs_index_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
}

function importDBFile() {
  document.getElementById('import-db-input').click();
}

async function importDB(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = '';
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (!Array.isArray(data)) throw new Error('ä¸æ­£ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ');
    vectorDB = data;
    saveDBToStorage();
    updateDBStatus();
    updateRepoList();
    showToast(`âœ… ${data.length}ãƒãƒ£ãƒ³ã‚¯ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
  } catch(e) {
    showToast(`âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}`);
  }
}

function clearDB() {
  if (!confirm('ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  vectorDB = [];
  sessionStorage.removeItem('kbs_vectordb');
  updateDBStatus();
  updateRepoList();
  showToast('ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ============================================================
//  MODAL HELPERS
// ============================================================
function openSettingsModal() {
  loadSettings();
  document.getElementById('settings-modal').style.display = 'block';
}

function openRepoModal() {
  updateRepoList();
  document.getElementById('repo-modal').style.display = 'block';
}

function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

// ============================================================
//  TOAST
// ============================================================
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2800);
}

document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('msg-input');
  input.addEventListener('focus', () => {
    setTimeout(scrollToBottom, 300);
  });
});
</script>
</body>
</html>
